@{
    ViewBag.Title = "Ký gửi của tôi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Form to add products to consignment history -->
<h3>Thêm sản phẩm Ký gửi</h3>
<form id="addProductForm">
    <label for="productName">Tên sản phẩm:</label>
    <input type="text" id="productName" name="productName" required /><br />

    <label for="age">Tuổi:</label>
    <input type="text" id="age" name="age" required /><br />

    <label for="gender">Giới tính:</label>
    <input type="text" id="gender" name="gender" required /><br />

    <label for="origin">Nguồn gốc:</label>
    <input type="text" id="origin" name="origin" required /><br />

    <label for="type">Chuẩn loại:</label>
    <input type="text" id="type" name="type" required /><br />

    <label for="characteristics">Tính cách:</label>
    <input type="text" id="characteristics" name="characteristics" required /><br />

    <label for="feeding">Lượng thức ăn/ngày:</label>
    <input type="text" id="feeding" name="feeding" required /><br />

    <label for="quantity">Số lượng:</label>
    <input type="number" id="quantity" name="quantity" required /><br />

    <label for="imageUrl">URL hình ảnh:</label>
    <input type="text" id="imageUrl" name="imageUrl" required /><br />

    <button type="submit">Thêm sản phẩm</button>
</form>

<h3>Danh sách Ký gửi</h3>
<table class="cart-table" id="historyTable">
    <thead>
        <tr>
            <th>Xoá</th>
            <th>Sản phẩm</th>
            <th>Tuổi</th>
            <th>Giới tính</th>
            <th>Nguồn gốc</th>
            <th>Chuẩn loại</th>
            <th>Tính cách</th>
            <th>Lượng thức ăn/ngày</th>
            <th>Số lượng</th>
            <th>Trạng thái</th>
        </tr>
    </thead>
    <tbody id="historyTableBody">
        <!-- Sản phẩm từ lịch sử ký gửi sẽ được hiển thị ở đây -->
    </tbody>
</table>

<!-- Cart Summary -->
<div class="cart-summary">
    <div class="summary-title">Tóm tắt ký gửi</div>
    <div class="summary-item">
        <span>Số lượng cá ký gửi offline: </span>
        <span>0</span> <!-- Offline quantity is always 0 -->
    </div>
    <div class="summary-item">
        <span>Số lượng cá ký gửi online:</span>
        <span id="onlineQuantity">0</span> <!-- Online quantity dynamically updated -->
    </div>
</div>

<script>
    // Retrieve data from localStorage
    function getData(key) {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
    }

    // Save data to localStorage
    function saveData(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    }

    // Update table display for consignment history
    function updateTable(data) {
        const tableBody = document.getElementById('historyTableBody');
        tableBody.innerHTML = '';

        data.forEach(item => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>
                    <button class="remove-button" onclick="removeFromHistory('${item.productName}')">Xoá</button>
                </td>
                <td>
                    <img src="${item.imageUrl}" alt="${item.productName}" style="width: 50px; height: 50px;">
                    <div>${item.productName}</div>
                </td>
                <td>${item.age}</td>
                <td>${item.gender}</td>
                <td>${item.origin}</td>
                <td>${item.type}</td>
                <td>${item.characteristics}</td>
                <td>${item.feeding}</td>
                <td>${item.quantity}</td>
                <td>${item.status}</td>
            `;
        });
    }

    // Function to handle adding a product
    document.getElementById('addProductForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const productName = document.getElementById('productName').value;
        const age = document.getElementById('age').value;
        const gender = document.getElementById('gender').value;
        const origin = document.getElementById('origin').value;
        const type = document.getElementById('type').value;
        const characteristics = document.getElementById('characteristics').value;
        const feeding = document.getElementById('feeding').value;
        const quantity = parseInt(document.getElementById('quantity').value);
        const imageUrl = document.getElementById('imageUrl').value;

        const newProduct = {
            productName,
            age,
            gender,
            origin,
            type,
            characteristics,
            feeding,
            quantity,
            imageUrl,
            price: 0, // Optional: Add price if needed
            status: "Chờ xác nhận"
        };

        // Add product to consignment history
        const history = getData('history');
        history.push(newProduct);
        saveData('history', history);

        // Update consignment history display
        updateTable(history);

        // Update online quantity summary
        updateOnlineQuantity();

        // Reset form
        document.getElementById('addProductForm').reset();
    });

    // Update the online quantity in the summary
    function updateOnlineQuantity() {
        const history = getData('history');
        const totalQuantity = history.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('onlineQuantity').textContent = totalQuantity;
    }

    // Remove product from consignment history
    function removeFromHistory(productName) {
        const history = getData('history');
        const updatedHistory = history.filter(item => item.productName !== productName);
        saveData('history', updatedHistory);
        updateTable(updatedHistory); // Update table after removal
        updateOnlineQuantity(); // Update the quantity summary
    }

    // Initialize page with consignment history and summary
    window.onload = function() {
        const history = getData('history');
        updateTable(history);
        updateOnlineQuantity();
    };
</script>
